<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PesterLog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:"Courier New", monospace;
  display:flex;
  height:100vh;
  background:#5f8fa8;
  visibility:hidden;
}
body.loaded{visibility:visible}

/* –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
#sidebar{
  width:280px;
  background:#ffcc00;
  padding:10px;
  box-sizing:border-box;
  border-right:6px solid #000;
}

#sidebar h4{
  margin:5px 0;
  font-weight:bold;
}

/* chumroll */
#users{
  background:#000;
  height:250px;
  overflow-y:auto;
  padding:5px;
  margin-bottom:10px;
}

.user{
  padding:5px;
  margin-bottom:4px;
  cursor:pointer;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
}

.user:hover{
  background:#222;
}

.status{font-size:12px}

/* –ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å */
#chat-container{
  flex:1;
  background:#7aa6c2;
  padding:15px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
}

/* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–∫–Ω–∞ */
.chat-header{
  background:#c78c00;
  color:#fff;
  padding:6px;
  font-weight:bold;
  text-align:center;
  border:4px solid #c78c00;
  margin-bottom:6px;
}

/* –æ–∫–Ω–æ —á–∞—Ç–∞ */
#chat{
  background:#e6e6e6;
  border:6px solid #c78c00;
  flex:1;
  padding:10px;
  overflow-y:auto;
  font-size:15px;
}

/* –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ */
.private-chat{
  border:4px solid #c78c00;
  background:#e6e6e6;
  padding:6px;
  margin-top:10px;
  height:200px;
  overflow-y:auto;
}

.private-chat .messages{
  max-height:130px;
  overflow-y:auto;
  margin-bottom:5px;
}

/* –∏–Ω–ø—É—Ç—ã */
input,button{
  font-family:"Courier New", monospace;
  font-weight:bold;
  border:3px solid #c78c00;
  padding:6px;
  margin-top:5px;
}

button{
  cursor:pointer;
  background:#ffcc00;
}

button:hover{
  background:#ffaa00;
}

#message{
  height:45px;
}
</style>
</head>

<body>

<div id="sidebar">
  <h4>CHUMROLL:</h4>
  <div id="users"></div>
</div>

<div id="chat-container">
  <div class="chat-header">:: pesterlog ::</div>
  <div id="chat"></div>

  <input id="name" placeholder="nickname">
  <input id="message" placeholder="message">
  <button onclick="send()">PESTER!</button>

  <div id="private-chats"></div>
</div>

<audio id="ping">
  <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
</audio>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const chat = document.getElementById("chat");
const usersDiv = document.getElementById("users");
const ping = document.getElementById("ping");
const privateChatsDiv = document.getElementById("private-chats");

let nickname="";
let color="";
let mood="";

const nickColors=["#FF4500","#1E90FF","#32CD32","#FFD700","#FF69B4","#8A2BE2","#00CED1","#FF6347","#FF1493","#00FA9A","#7FFF00","#DA70D6","#00BFFF"];

const adjectives=["–≤–∏–Ω–∏–ª–æ–≤—ã–π","–ø—É—Ä–ø—É—Ä–Ω—ã–π","–∫–æ—Å–º–∏—á–µ—Å–∫–∏–π","—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π","–ª—É–Ω–Ω—ã–π","—Å–µ—Ä–µ–±—Ä—è–Ω—ã–π","–ø—ã–ª–∞—é—â–∏–π","—Ç—É–º–∞–Ω–Ω—ã–π"];
const nouns=["–î–µ–º–∏—Ä—É–≥","–•—Ä–∞–Ω–∏—Ç–µ–ª—å","–ö–æ—Ä–æ–ª—å","–°–∫–∏—Ç–∞–ª–µ—Ü","–¢—Ä–∏–∫—Å—Ç–µ—Ä","–ú–∞–≥","–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä","–¢–µ–Ω—å"];

function randomNick(){return adjectives[Math.floor(Math.random()*adjectives.length)]+nouns[Math.floor(Math.random()*nouns.length)]}
function randomColor(){return nickColors[Math.floor(Math.random()*nickColors.length)]}

function shortNick(nick){
  const map={
    "–õ—É–Ω–Ω—ã–π–¢—Ä–∏–∫—Å—Ç–µ—Ä":"–õ–¢",
    "–ö–æ—Ä–æ–ª—å–ë–æ—Ç–∞–Ω–æ–≤":"–ö–ë"
  };
  return map[nick]||nick.slice(0,2).toUpperCase();
}

window.onload=()=>{
  let savedNick=localStorage.getItem("pesterNick");
  let savedColor=localStorage.getItem("pesterColor");
  let savedMood=localStorage.getItem("pesterMood");

  if(savedNick&&savedColor){nickname=savedNick;color=savedColor;}
  else{
    nickname=randomNick();
    color=randomColor();
    localStorage.setItem("pesterNick",nickname);
    localStorage.setItem("pesterColor",color);
  }

  mood=savedMood||"üòÉ";
  localStorage.setItem("pesterMood",mood);

  document.getElementById("name").value=nickname;

  const sys=document.createElement("div");
  sys.innerHTML=`-- [${shortNick("–õ—É–Ω–Ω—ã–π–¢—Ä–∏–∫—Å—Ç–µ—Ä")}] –Ω–∞—á–∞–ª –¥–æ—Å—Ç–∞–≤–∞—Ç—å [${shortNick("–ö–æ—Ä–æ–ª—å–ë–æ—Ç–∞–Ω–æ–≤")}] --`;
  chat.appendChild(sys);

  socket.emit("join",{name:nickname,color:color,mood:mood});
  document.body.classList.add("loaded");
};

document.getElementById("name").addEventListener("change",()=>{
  nickname=document.getElementById("name").value;
  localStorage.setItem("pesterNick",nickname);
  socket.emit("join",{name:nickname,color:color,mood:mood});
});

function send(){
  const message=document.getElementById("message").value;
  if(!nickname||!message)return;
  socket.emit("chat message",{name:nickname,color:color,message:message});
  document.getElementById("message").value="";
}

socket.on("user list",(users)=>{
  usersDiv.innerHTML="";
  users.forEach(user=>{
    if(user.name===nickname)return;
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`<span style="color:${user.color}">${user.name}</span><span class="status">${user.mood}</span>`;
    div.onclick=()=>openPrivateChat(user.name,user.color);
    usersDiv.appendChild(div);
  });
});

let openChats={};

function openPrivateChat(to,toColor){
  if(openChats[to])return;
  const chatDiv=document.createElement("div");
  chatDiv.className="private-chat";
  chatDiv.innerHTML=`<strong style="color:${toColor}">${to}</strong>
  <div class="messages"></div>
  <input placeholder="message">
  <button class="send-btn">PESTER!</button>`;
  privateChatsDiv.appendChild(chatDiv);
  openChats[to]=chatDiv;

  const input=chatDiv.querySelector("input");
  const button=chatDiv.querySelector(".send-btn");
  const messagesDiv=chatDiv.querySelector(".messages");

  button.onclick=()=>{
    const msg=input.value;
    if(!msg)return;
    socket.emit("private message",{from:nickname,to,message:msg,color});
    input.value="";
  };

  socket.on("private message",(data)=>{
    if((data.from===nickname&&data.to===to)||(data.from===to&&data.to===nickname)){
      const div=document.createElement("div");
      div.innerHTML=`<span style="color:${data.color};font-weight:bold">${data.from}:</span> ${data.message}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    }
  });
}

socket.on("chat message",(data)=>{
  const div=document.createElement("div");
  div.innerHTML=`<span style="color:${data.color};font-weight:bold">${data.name}:</span> ${data.message}`;
  chat.appendChild(div);
  ping.play();
  chat.scrollTop=chat.scrollHeight;
});
</script>

</body>
</html>