<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>pester mini</title>
<style>
body {background:black;color:white;font-family:monospace;display:flex;}
#sidebar {width:150px;border-right:2px solid lime;padding:10px;}
#chat-container {flex:1;padding:10px;}
#chat {height:200px;overflow-y:auto;border:2px solid white;padding:10px;margin-bottom:10px;}
.private-chat {border:1px solid cyan;padding:5px;margin-top:5px;height:150px;overflow-y:auto;}
input, button {background:black;color:lime;border:1px solid lime;font-family:monospace;margin:2px 0;}
.user {cursor:pointer;margin-bottom:5px;}
.status {font-size:10px;color:gray;}
</style>
</head>
<body>

<div id="sidebar">
  <h4>chums</h4>
  <div id="users"></div>
</div>

<div id="chat-container">
  <h3>общий чат</h3>
  <div id="chat"></div>
  <input id="name" placeholder="nickname">
  <input id="color" type="color" value="#00ff00">
  <input id="message" placeholder="message">
  <button onclick="send()">send</button>

  <div id="private-chats"></div>
</div>

<audio id="ping">
  <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg">
</audio>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const chat = document.getElementById("chat");
const usersDiv = document.getElementById("users");
const ping = document.getElementById("ping");
const privateChatsDiv = document.getElementById("private-chats");

let nickname = "";
let color = "";

// вводим ник
document.getElementById("name").addEventListener("change", () => {
  nickname = document.getElementById("name").value;
  color = document.getElementById("color").value;
  socket.emit("join", {name: nickname, color: color});
});

// общий чат
function send() {
  const message = document.getElementById("message").value;
  if(!nickname) return alert("enter nickname first");
  socket.emit("chat message", {name: nickname, color: color, message: message});
  document.getElementById("message").value = "";
}

socket.on("chat message", function(data) {
  const div = document.createElement("div");
  div.innerHTML = `<span style="color:${data.color}">${data.name}:</span> ${data.message}`;
  chat.appendChild(div);
  ping.play();
  chat.scrollTop = chat.scrollHeight;
});

// список пользователей (корешей)
socket.on("user list", function(users) {
  usersDiv.innerHTML = "";
  users.forEach(user => {
    if(user.name === nickname) return; // не показываем себя
    const div = document.createElement("div");
    div.className = "user";
    div.innerHTML = `<span style="color:${user.color}">${user.name}</span><div class="status">online</div>`;
    div.onclick = () => openPrivateChat(user.name, user.color);
    usersDiv.appendChild(div);
  });
});

// приватные чаты
let openChats = {}; // toName -> div
function openPrivateChat(to, toColor) {
  if(openChats[to]) return; // уже открыт
  const chatDiv = document.createElement("div");
  chatDiv.className = "private-chat";
  chatDiv.innerHTML = `<strong style="color:${toColor}">${to}</strong><div class="messages"></div>
  <input placeholder="message"><button>send</button>`;
  privateChatsDiv.appendChild(chatDiv);
  openChats[to] = chatDiv;

  const input = chatDiv.querySelector("input");
  const button = chatDiv.querySelector("button");
  const messagesDiv = chatDiv.querySelector(".messages");

  button.onclick = () => {
    const msg = input.value;
    if(!msg) return;
    socket.emit("private message", {from: nickname, to, message: msg, color});
    input.value = "";
  };

  socket.on("private message", (data) => {
    if(data.from !== nickname && data.from !== to) return; // чужие сообщения
    const div = document.createElement("div");
    div.innerHTML = `<span style="color:${data.color}">${data.from}:</span> ${data.message}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}
</script>

</body>
</html><div id="chat"></div>

<input id="name" placeholder="nickname">
<input id="message" placeholder="message">
<button onclick="send()">send</button>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const chat = document.getElementById("chat");

function send() {
  const name = document.getElementById("name").value;
  const message = document.getElementById("message").value;
  socket.emit("chat message", name + ": " + message);
  document.getElementById("message").value = "";
}

socket.on("chat message", function(msg) {
  const div = document.createElement("div");
  div.textContent = msg;
  chat.appendChild(div);
});
</script>

</body>
</html>
